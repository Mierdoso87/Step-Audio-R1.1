# Step-Audio-R1.1 All-in-One Docker Compose
# 单容器包含 vLLM + Web UI + API

services:
  step-audio:
    image: neosun/step-audio-r1.1:latest
    container_name: step-audio-r1.1
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - TENSOR_PARALLEL_SIZE=${TENSOR_PARALLEL_SIZE:-4}
      - MAX_MODEL_LEN=${MAX_MODEL_LEN:-65536}
      - MAX_NUM_SEQS=${MAX_NUM_SEQS:-4}
      - GPU_MEMORY_UTILIZATION=${GPU_MEMORY_UTILIZATION:-0.85}
    volumes:
      - ${MODEL_PATH:-./Step-Audio-R1.1}:/model:ro
      - /tmp/step-audio-r1:/tmp/step-audio-r1
    ports:
      - "0.0.0.0:${WEB_PORT:-9100}:9100"    # Web UI + API
      - "0.0.0.0:${VLLM_PORT:-9101}:9999"   # vLLM API
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9999/health && curl -sf http://localhost:9100/health || exit 1"]
      interval: 60s
      timeout: 30s
      retries: 10
      start_period: 300s
