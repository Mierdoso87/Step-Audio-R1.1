<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step-Audio-R1.1 - Audio Language Model</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #2a2a3a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .header p { color: var(--text-secondary); font-size: 14px; }
        
        /* Language Switcher */
        .lang-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
        }
        .lang-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .lang-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Status Card */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        .status-item {
            text-align: center;
        }
        .status-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }
        .status-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Mode Selection */
        .mode-group { margin-bottom: 12px; }
        .mode-group-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }
        .mode-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .mode-tab {
            padding: 10px 16px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .mode-tab:hover { border-color: var(--accent); }
        .mode-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 48px; margin-bottom: 12px; }
        .upload-text { color: var(--text-primary); margin-bottom: 4px; }
        .upload-hint { color: var(--text-secondary); font-size: 12px; }
        .file-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-top: 12px;
        }
        .file-info.hidden { display: none; }
        .file-name { color: var(--success); }
        .btn-remove {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 18px;
        }
        
        /* Options */
        .options-section { margin-bottom: 16px; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .section-content { padding: 16px 0; }
        .section-content.collapsed { display: none; }
        .option-row {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }
        .option-group { flex: 1; }
        .option-group.half { flex: 0.5; }
        .option-label {
            display: block;
            font-size: 13px;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }
        .option-input, .option-textarea, .option-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }
        .option-input:focus, .option-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        .option-hint {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            display: block;
        }
        
        /* Process Button */
        .btn-process {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn-process:hover { transform: translateY(-2px); }
        .btn-process:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Progress */
        .progress-container { margin: 16px 0; }
        .progress-container.hidden { display: none; }
        .progress-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #a855f7);
            width: 0%;
            transition: width 0.3s;
            animation: progress-pulse 1.5s infinite;
        }
        @keyframes progress-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .progress-text {
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        /* Result */
        .result-card.hidden { display: none; }
        .result-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .result-title { font-size: 16px; font-weight: 600; }
        .btn-copy {
            margin-left: auto;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
        }
        .result-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .result-section-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .result-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 14px;
        }
        .thinking-content {
            color: var(--text-secondary);
            font-style: italic;
            max-height: 200px;
            overflow-y: auto;
        }
        .timing-info {
            display: flex;
            gap: 24px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .status-grid { grid-template-columns: repeat(2, 1fr); }
            .option-row { flex-direction: column; }
            .option-group.half { flex: 1; }
        }
    </style>
</head>
<body>
    <div class="lang-switcher">
        <button class="lang-btn active" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="zh">‰∏≠Êñá</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Step-Audio-R1.1</h1>
            <p data-i18n="subtitle">Audio Language Model with Reasoning</p>
        </div>

        <!-- Status Card -->
        <div class="card">
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-value" id="modelStatus">Ready</div>
                    <div class="status-label" data-i18n="model">Model</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="processing">0</div>
                    <div class="status-label" data-i18n="processing">Processing</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="completed">0</div>
                    <div class="status-label" data-i18n="completed">Completed</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="avgTime">0s</div>
                    <div class="status-label" data-i18n="avgTime">Avg Time</div>
                </div>
            </div>
        </div>

        <!-- Mode Selection -->
        <div class="card">
            <div class="card-title">üéØ <span data-i18n="selectMode">Select Mode</span></div>
            <div class="mode-group" style="margin-top: 16px;">
                <span class="mode-group-label" data-i18n="coreModes">Core Modes</span>
                <div class="mode-tabs">
                    <button class="mode-tab active" data-mode="s2t">
                        <span>üìù</span><span data-i18n="s2t">Speech to Text</span>
                    </button>
                    <button class="mode-tab" data-mode="understand">
                        <span>üß†</span><span data-i18n="understand">Audio Understanding</span>
                    </button>
                    <button class="mode-tab" data-mode="translate">
                        <span>üåê</span><span data-i18n="translate">Translate</span>
                    </button>
                </div>
            </div>
            <div class="mode-group">
                <span class="mode-group-label" data-i18n="extendedModes">Extended Modes</span>
                <div class="mode-tabs">
                    <button class="mode-tab" data-mode="asr">
                        <span>üé§</span><span data-i18n="asr">ASR Transcribe</span>
                    </button>
                    <button class="mode-tab" data-mode="summarize">
                        <span>üìã</span><span data-i18n="summarize">Summarize</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Upload -->
        <div class="card">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="audioInput" accept="audio/*">
                <div class="upload-icon">üéµ</div>
                <div class="upload-text" data-i18n="dropAudio">Drop audio file here or click to upload</div>
                <div class="upload-hint" data-i18n="supportedFormats">Supports WAV, MP3, FLAC, M4A</div>
            </div>
            <div class="file-info hidden" id="fileInfo">
                <span class="file-name" id="fileName"></span>
                <button class="btn-remove" id="removeFile">‚úï</button>
            </div>
        </div>

        <!-- Options -->
        <div class="card" id="optionsPanel">
            <!-- Generation Settings -->
            <div class="options-section">
                <div class="section-header" onclick="toggleSection('genOptions')">
                    <span>‚öôÔ∏è <span data-i18n="genSettings">Generation Settings</span></span>
                    <span class="toggle-icon" id="genOptionsIcon">‚ñº</span>
                </div>
                <div class="section-content" id="genOptions">
                    <div class="option-row">
                        <div class="option-group half">
                            <label class="option-label" data-i18n="maxTokens">Max Tokens</label>
                            <input type="number" class="option-input" id="maxTokens" value="2048" min="64" max="8192">
                        </div>
                        <div class="option-group half">
                            <label class="option-label" data-i18n="temperature">Temperature</label>
                            <input type="number" class="option-input" id="temperature" value="0.7" min="0" max="2" step="0.1">
                        </div>
                    </div>
                    <div class="option-row">
                        <div class="option-group half">
                            <label class="option-label">Top P</label>
                            <input type="number" class="option-input" id="topP" value="0.9" min="0" max="1" step="0.05">
                        </div>
                        <div class="option-group half">
                            <label class="option-label" data-i18n="repPenalty">Repetition Penalty</label>
                            <input type="number" class="option-input" id="repetitionPenalty" value="1.0" min="1" max="2" step="0.1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode-specific Options -->
            <div class="options-section" id="s2tSection">
                <div class="section-header" onclick="toggleSection('s2tOptions')">
                    <span>üìù <span data-i18n="s2tOptions">S2T Options</span></span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content" id="s2tOptions">
                    <div class="option-group">
                        <label class="option-label" data-i18n="instruction">Additional Instruction</label>
                        <input type="text" class="option-input" id="instruction" placeholder="e.g., Summarize briefly, Answer in 50 words...">
                    </div>
                </div>
            </div>

            <div class="options-section hidden" id="translateSection">
                <div class="section-header" onclick="toggleSection('translateOptions')">
                    <span>üåê <span data-i18n="translateOptions">Translate Options</span></span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content" id="translateOptions">
                    <div class="option-group">
                        <label class="option-label" data-i18n="targetLang">Target Language</label>
                        <select class="option-input" id="targetLang">
                            <option value="Chinese">Chinese (‰∏≠Êñá)</option>
                            <option value="English">English</option>
                            <option value="Japanese">Japanese (Êó•Êú¨Ë™û)</option>
                            <option value="Korean">Korean (ÌïúÍµ≠Ïñ¥)</option>
                            <option value="French">French (Fran√ßais)</option>
                            <option value="German">German (Deutsch)</option>
                            <option value="Spanish">Spanish (Espa√±ol)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="options-section hidden" id="understandSection">
                <div class="section-header" onclick="toggleSection('understandOptions')">
                    <span>üß† <span data-i18n="understandOptions">Understanding Options</span></span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content" id="understandOptions">
                    <div class="option-group">
                        <label class="option-label" data-i18n="question">Question about the audio</label>
                        <input type="text" class="option-input" id="question" placeholder="e.g., What is the main topic? What emotion is expressed?">
                    </div>
                </div>
            </div>
        </div>

        <!-- Process Button -->
        <button class="btn-process" id="processBtn" disabled>
            <span>‚ñ∂</span>
            <span data-i18n="processAudio">Process Audio</span>
        </button>

        <!-- Progress -->
        <div class="progress-container hidden" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText" data-i18n="processingText">Processing...</div>
        </div>

        <!-- Result -->
        <div class="card result-card hidden" id="resultCard">
            <div class="result-header">
                <span>‚ú®</span>
                <span class="result-title" data-i18n="result">Result</span>
                <button class="btn-copy" onclick="copyResult()">üìã Copy</button>
            </div>
            
            <div class="result-section" id="thinkingSection">
                <div class="result-section-title" data-i18n="thinking">üí≠ Thinking Process</div>
                <div class="result-content thinking-content" id="thinkingContent"></div>
            </div>
            
            <div class="result-section">
                <div class="result-section-title" data-i18n="answer">üìù Answer</div>
                <div class="result-content" id="answerContent"></div>
            </div>
            
            <div class="timing-info">
                <span>‚è±Ô∏è <span data-i18n="elapsed">Elapsed</span>: <span id="elapsedTime">0s</span></span>
            </div>
        </div>
    </div>

    <script>
        // i18n
        const i18n = {
            en: {
                subtitle: 'Audio Language Model with Reasoning',
                model: 'Model', processing: 'Processing', completed: 'Completed', avgTime: 'Avg Time',
                selectMode: 'Select Mode', coreModes: 'Core Modes', extendedModes: 'Extended Modes',
                s2t: 'Speech to Text', understand: 'Audio Understanding', translate: 'Translate',
                asr: 'ASR Transcribe', summarize: 'Summarize',
                dropAudio: 'Drop audio file here or click to upload',
                supportedFormats: 'Supports WAV, MP3, FLAC, M4A',
                genSettings: 'Generation Settings', maxTokens: 'Max Tokens', temperature: 'Temperature',
                repPenalty: 'Repetition Penalty',
                s2tOptions: 'S2T Options', instruction: 'Additional Instruction',
                translateOptions: 'Translate Options', targetLang: 'Target Language',
                understandOptions: 'Understanding Options', question: 'Question about the audio',
                processAudio: 'Process Audio', processingText: 'Processing...',
                result: 'Result', thinking: 'üí≠ Thinking Process', answer: 'üìù Answer', elapsed: 'Elapsed'
            },
            zh: {
                subtitle: 'ÂÖ∑ÊúâÊé®ÁêÜËÉΩÂäõÁöÑÈü≥È¢ëËØ≠Ë®ÄÊ®°Âûã',
                model: 'Ê®°Âûã', processing: 'Â§ÑÁêÜ‰∏≠', completed: 'Â∑≤ÂÆåÊàê', avgTime: 'Âπ≥ÂùáÊó∂Èó¥',
                selectMode: 'ÈÄâÊã©Ê®°Âºè', coreModes: 'Ê†∏ÂøÉÊ®°Âºè', extendedModes: 'Êâ©Â±ïÊ®°Âºè',
                s2t: 'ËØ≠Èü≥ËΩ¨ÊñáÂ≠ó', understand: 'Èü≥È¢ëÁêÜËß£', translate: 'ÁøªËØë',
                asr: 'ASR ËΩ¨ÂΩï', summarize: 'ÊÄªÁªì',
                dropAudio: 'ÊãñÊîæÈü≥È¢ëÊñá‰ª∂ÊàñÁÇπÂáª‰∏ä‰º†',
                supportedFormats: 'ÊîØÊåÅ WAV, MP3, FLAC, M4A',
                genSettings: 'ÁîüÊàêËÆæÁΩÆ', maxTokens: 'ÊúÄÂ§ßTokenÊï∞', temperature: 'Ê∏©Â∫¶',
                repPenalty: 'ÈáçÂ§çÊÉ©ÁΩö',
                s2tOptions: 'ËØ≠Èü≥ËΩ¨ÊñáÂ≠óÈÄâÈ°π', instruction: 'ÈôÑÂä†Êåá‰ª§',
                translateOptions: 'ÁøªËØëÈÄâÈ°π', targetLang: 'ÁõÆÊ†áËØ≠Ë®Ä',
                understandOptions: 'ÁêÜËß£ÈÄâÈ°π', question: 'ÂÖ≥‰∫éÈü≥È¢ëÁöÑÈóÆÈ¢ò',
                processAudio: 'Â§ÑÁêÜÈü≥È¢ë', processingText: 'Â§ÑÁêÜ‰∏≠...',
                result: 'ÁªìÊûú', thinking: 'üí≠ ÊÄùËÄÉËøáÁ®ã', answer: 'üìù ÂõûÁ≠î', elapsed: 'ËÄóÊó∂'
            }
        };
        let currentLang = 'en';

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang][key]) el.textContent = i18n[lang][key];
            });
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
        }

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
        });

        // State
        let selectedFile = null;
        let currentMode = 's2t';

        // Mode selection
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentMode = tab.dataset.mode;
                updateModeOptions();
            });
        });

        function updateModeOptions() {
            document.getElementById('s2tSection').classList.toggle('hidden', !['s2t'].includes(currentMode));
            document.getElementById('translateSection').classList.toggle('hidden', currentMode !== 'translate');
            document.getElementById('understandSection').classList.toggle('hidden', currentMode !== 'understand');
        }

        function toggleSection(id) {
            const section = document.getElementById(id);
            section.classList.toggle('collapsed');
        }

        // File upload
        const uploadZone = document.getElementById('uploadZone');
        const audioInput = document.getElementById('audioInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const processBtn = document.getElementById('processBtn');

        uploadZone.addEventListener('click', () => audioInput.click());
        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        audioInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });
        document.getElementById('removeFile').addEventListener('click', clearFile);

        function handleFile(file) {
            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.classList.remove('hidden');
            processBtn.disabled = false;
        }

        function clearFile() {
            selectedFile = null;
            fileInfo.classList.add('hidden');
            processBtn.disabled = true;
            audioInput.value = '';
        }

        // Process
        processBtn.addEventListener('click', processAudio);

        async function processAudio() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('audio', selectedFile);
            formData.append('mode', currentMode);
            formData.append('max_tokens', document.getElementById('maxTokens').value);
            formData.append('temperature', document.getElementById('temperature').value);
            formData.append('top_p', document.getElementById('topP').value);
            formData.append('repetition_penalty', document.getElementById('repetitionPenalty').value);
            formData.append('instruction', document.getElementById('instruction').value);
            formData.append('target_lang', document.getElementById('targetLang').value);
            formData.append('question', document.getElementById('question').value);

            processBtn.disabled = true;
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('resultCard').classList.add('hidden');
            
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressInterval = setInterval(() => {
                progress = Math.min(progress + Math.random() * 10, 90);
                progressFill.style.width = progress + '%';
            }, 500);

            try {
                const response = await fetch('/api/process', { method: 'POST', body: formData });
                const data = await response.json();

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                if (data.status === 'success') {
                    document.getElementById('thinkingContent').textContent = data.thinking || 'No thinking process';
                    document.getElementById('answerContent').textContent = data.answer || data.full_response;
                    document.getElementById('elapsedTime').textContent = data.elapsed_time + 's';
                    document.getElementById('resultCard').classList.remove('hidden');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                clearInterval(progressInterval);
                alert('Request failed: ' + err.message);
            } finally {
                processBtn.disabled = false;
                setTimeout(() => {
                    document.getElementById('progressContainer').classList.add('hidden');
                    progressFill.style.width = '0%';
                }, 500);
            }
        }

        function copyResult() {
            const answer = document.getElementById('answerContent').textContent;
            navigator.clipboard.writeText(answer);
        }

        // Status polling
        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                document.getElementById('processing').textContent = data.stats.processing;
                document.getElementById('completed').textContent = data.stats.completed;
                const avg = data.stats.completed > 0 ? (data.stats.total_time / data.stats.completed).toFixed(1) : 0;
                document.getElementById('avgTime').textContent = avg + 's';
            } catch (e) {}
        }
        setInterval(updateStatus, 5000);
        updateStatus();
    </script>
</body>
</html>
